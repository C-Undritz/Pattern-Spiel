let playButton = document.getElementById("play-game");
let gridSize;
let colourPalette;
let viewTimerSelected;
let playerTimerSelected;
let userColourSelected;
let computerPattern;
let gameRound = 1;
let startedGame = false;
var timer; //----------------------------------------------------------------------------------------------------------------------------------------------
var ms = 0; //----------------------------------------------------------------------------------------------------------------------------------------------
var s = 0; //----------------------------------------------------------------------------------------------------------------------------------------------
var m = 0; //----------------------------------------------------------------------------------------------------------------------------------------------

function gridSizeSelection() {
    let optionButtons = `
    <button class="gameOptionsButton" id="3" onclick="colourNumberSelection(3)">3 x 3 grid</button>
    <button class="gameOptionsButton" id="4" onclick="colourNumberSelection(4)">4 x 4 grid</button>
    `;
    document.getElementById('game-options').innerHTML = optionButtons;
}

playButton.addEventListener('click', gridSizeSelection);

function colourNumberSelection(gridSelection) {
    gridSize = gridSelection;
    let optionButtons = `
    <button class="gameOptionsButton" id="4" onclick="viewTimerSelection(4)">Up to 4 colours</button>
    <button class="gameOptionsButton" id="5" onclick="viewTimerSelection(5)">Up to 5 colours</button>
    <button class="gameOptionsButton" id="6" onclick="viewTimerSelection(6)">Up to 6 colours</button>
    `;
    document.getElementById('game-options').innerHTML = optionButtons;
}

function viewTimerSelection(colourSelection) {
    colourPalette = colourSelection;
    let optionButtons = `
    <button class="gameOptionsButton" id="0" onclick="playerTimerSelection(0)">No Timer</button>
    <button class="gameOptionsButton" id="5" onclick="playerTimerSelection(5)">5 Seconds</button>
    <button class="gameOptionsButton" id="10" onclick="playerTimerSelection(10)">10 seconds</button>
    <button class="gameOptionsButton" id="15" onclick="playerTimerSelection(15)">15 seconds</button>
    `;
    document.getElementById('game-options').innerHTML = optionButtons;
}

function playerTimerSelection(viewTimerSelection) {
    viewTimerSelected = viewTimerSelection;
    let optionButtons = `
    <button class="gameOptionsButton" id="0" onclick="playGame(0)">No Timer</button>
    <button class="gameOptionsButton" id="10" onclick="playGame(10)">10 Seconds</button>
    <button class="gameOptionsButton" id="15" onclick="playGame(15)">15 seconds</button>
    <button class="gameOptionsButton" id="20" onclick="playGame(20)">20 seconds</button>
    `;
    document.getElementById('game-options').innerHTML = optionButtons;
}

function playGame(playerTimerSelection) {
    playerTimerSelected = playerTimerSelection;
    console.log(gridSize);
    console.log(colourPalette);
    console.log(viewTimerSelected);
    console.log(playerTimerSelected);
    let optionButtons = `
    <button class="gameOptionsButton" id="0" onclick="generateComputerGrid()">Play Game!</button>
    `;
    document.getElementById('game-options').innerHTML = optionButtons;
}

function generateComputerGrid() {
    if (startedGame) {
        let palette = document.getElementById('palette-area'); 
        let message = document.getElementById('messages-box'); 
        palette.remove(); // removes palette when viewing computer generated pattern between rounds.      
        message.remove(); // removes end of round message generated by function gameStatus().
        m = 0;
        s = 0;
        ms = 0;
    }
        console.log(gridSize);
    let grid = `
    <div class="container${gridSize}x${gridSize}">
    `;
    for (let i = 0; i < (gridSize*gridSize); i++) {
        let rowGrid = `
            <div class="board${gridSize} squares" id="${i}"></div>
            `;
            grid += rowGrid;  
        }
    grid += `
        </div>
    `;
    document.getElementById('game-options').innerHTML = grid;
    addPattern();
    viewTimer();
}

function addPattern() {
    //create array of between 9 and 25 (depending on grid size) which consists of random numbers between 0 and the colourPalette variable (4, 5 or 6)
    var newPattern = [];
    for (let i = 0; i < (gridSize*gridSize); i++) {
        let number = Math.floor(Math.random() *colourPalette);
        newPattern.push(number);
    }
    console.log(newPattern);
    computerPattern = newPattern;

    //using newPattern array to assign colours to the grid
    for (let i in newPattern) {
        var setColor = document.getElementById(i);
        if (newPattern[i] === 0) {
        setColor.style.backgroundColor = "red";
        }
        else if (newPattern[i] === 1) {
        setColor.style.backgroundColor = "green";
        }
        else if (newPattern[i] === 2) {
        setColor.style.backgroundColor = "blue";
        }
        else if (newPattern[i] === 3) {
        setColor.style.backgroundColor = "yellow";
        }
        else if (newPattern[i] === 4) {
        setColor.style.backgroundColor = "purple";
        }
        else {
        setColor.style.backgroundColor = "orange";
        }
    }
}

// timer code adapted from 'Code with Ania KubÃ³w' Youtube channel video: "Build your own COUNTDOWN TIMER in 15 lines of JavaScript code" (https://www.youtube.com/watch?v=vSV_Ml2_A88&t=19s)
// with help from Bim who informed me that set interval should be declared as a variable
function viewTimer() {
    let timerDisplay = document.getElementById("game-triggers");
    let currentTimer = document.createElement("h3");
    currentTimer.setAttribute('class', 'current-timer');
    timerDisplay.appendChild(currentTimer);

    let timeLeft = viewTimerSelected;
    let patternDisplayTimer = setInterval(function() {
        if(timeLeft <= 0 ) {
            clearInterval(patternDisplayTimer);
            console.log("timer complete");
            generatePlayerGrid()
        }
        currentTimer.innerHTML = timeLeft;
        timeLeft -=1;
    }, 1000);
}

function generatePlayerGrid() {
    console.log(gridSize); 
    let grid = `
    <div class="container${gridSize}x${gridSize}">
    `;
    for (let i = 0; i < (gridSize*gridSize); i++) {
    let rowGrid = `
        <div class="board${gridSize} squares" id="square${i}" onclick="addColour(${i})"></div>
        `;
        grid += rowGrid;  
    }
    grid += `
        </div>
    `;
    document.getElementById('game-options').innerHTML = grid;
    generatePalette();
    start() //-----------------------------------------------------------------------------------------------------------------------------------------------
}

//https://www.youtube.com/watch?v=oY8V6GuZrkM -------------------------------------------------------------------------------------------------------
function start() {
  timer = setInterval(run, 10); // 10 so that the function is called 100 times a second.
}

function run() { //---------------------------------------------------------------------------------------------------------------------------------------
    ms++;
    if(ms == 100) {
        ms = 0;
        s++;
    }
    if(s == 60) {
        s = 0;
        m++;
    }
}

function generatePalette() {
    console.log(colourPalette)
    let colourArray = ['red', 'green', 'blue', 'yellow', 'purple', 'orange']

    let palette = `
        <div id="palette-area">
    `;
    for (let i = 0; i < (colourPalette); i++) {
    let insertColour = `
        <div class="color-selector" id="${colourArray[i]}" onclick="pickColour('${colourArray[i]}')"></div>
        `;
        palette += insertColour;
    }
    palette += `
        </div>
    `;
    document.getElementById('right-column').innerHTML = palette;
    generateSubmitButton();
}

function generateSubmitButton() {
    console.log("generating submit button");
    let submitButton = `
    <button id="submit-button" onclick="userPatternArray()">Submit</button>`;
    document.getElementById('game-triggers').innerHTML = submitButton;
}

function pickColour(colourChosen) {
    console.log(colourChosen);
    userColourSelected = colourChosen;
    console.log(userColourSelected);
}

function addColour(identifier, colourChosen) {
    console.log(userColourSelected);
    let selectedSquare = document.getElementById('square'+identifier);
    if (userColourSelected) {
        selectedSquare.style.backgroundColor = userColourSelected;
    } else {
        alert("you need to select a colour");
    }  
}

function userPatternArray() {
    var gridOfSquares = document.getElementsByClassName('squares');
    squareCount = gridOfSquares.length;
    console.log(squareCount);
    let userPattern = [];
    for (let i = 0; i < squareCount; i++) {
        if (gridOfSquares[i].style.backgroundColor === "red") {
        userPattern.push(0);
        }
        else if (gridOfSquares[i].style.backgroundColor === "green") {
        userPattern.push(1);
        }
        else if (gridOfSquares[i].style.backgroundColor === "blue") {
        userPattern.push(2);
        }
        else if (gridOfSquares[i].style.backgroundColor === "yellow") {
        userPattern.push(3);
        }
        else if (gridOfSquares[i].style.backgroundColor === "purple") {
        userPattern.push(4);
        }
        else {
        userPattern.push(5);
        }
    }
    gameStatus(userPattern)
}

function gameStatus(userPattern) {
    startedGame = true; //ensures that the end of round message generated by this function can be removed between rounds by generateComputerGrid() function.
    gameRound += 1;
    console.log("the current round is " + gameRound);
    console.log('the user pattern is: ' + userPattern);
    console.log('the AI pattern is: ' + computerPattern);
    let score = 0;
    let totalScore;
    let result;

    let submitButton = document.getElementById('submit-button');
    submitButton.remove();

    clearInterval(timer)//-----------------------------------------------------------------------------------------------------
    console.log("You took " + m + "minutes");
    console.log("You took " + s + "seconds");
    console.log("You took " + ms + "miliseconds");

    for (i = 0; i <computerPattern.length; i++) {
        if (userPattern[i] === computerPattern[i]) {
            score += 1;
        }
    }

    console.log("the result is " + score);

    if (score === userPattern.length) {
        result = "Win";
        console.log("you win");
        console.log("You got 100% right!");
        totalScore += 1;
        console.log("your total score is " + totalScore);
    } else {
        result = "Loss";
        console.log("you loose");
        console.log("You got " + ((score/userPattern.length)*100) +"% right");
        console.log("your total score is " + totalScore);
    }

    //Adds result of the round to the score column
    let displayResults = document.getElementById("score-column");
    let newScore = document.createElement("h3");
    let playerTime = document.createElement("h2");
    newScore.innerHTML = result;
    playerTime.innerHTML = s + ":" + ms;
    newScore.setAttribute('class', 'result-entry');
    playerTime.setAttribute('class', 'result-entry');
    displayResults.appendChild(newScore);
    displayResults.appendChild(playerTime);

	//Opens up the end of round message box for player to trigger next round or to notify end of current game.
    if (gameRound < 6) {
        let message = `
        <div id="messages-box">
            <h2>You got a ${result}</h2>
            <h2>Your time: ${s}:${ms}</h2>
            <h3>Ready for round ${gameRound}</h3>
            <button onclick="generateComputerGrid()">Next Round</button>
        </div>
        `;
        document.getElementById('messages').innerHTML = message;
        } else {
        console.log("end of game");
        if (totalScore === 5) {
            let message = `
            <div id="messages-box">
                <h2>You got top marks!</h2>
                <button onclick="playAgain()">Play again?</button>
                <button onclick="">Main menu"</button>
            </div>
            `;
            document.getElementById('messages').innerHTML = message;
        } else {
            console.log("end of game");
            let message = `
            <div id="messages-box">
                <h2>You scored ${totalScore}</h2>
                <button onclick="playAgain()">Play again?</button>
                <button onclick="">Main menu"</button>
            </div>
            `;
            document.getElementById('messages').innerHTML = message;
        }
    }
}

function playAgain() {
    startedGame = false;
    let message = document.getElementById('messages-box');
    let palette = document.getElementById('palette-area'); 
    palette.remove(); 
    message.remove();
    for (let i = 0; i < 5; i++) {
        let heading = document.getElementsByClassName('result-entry')[0];
        heading.remove();
    }
    m = 0;
    s = 0;
    ms = 0;
    generateComputerGrid();
}